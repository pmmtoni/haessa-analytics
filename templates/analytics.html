{% extends "base.html" %}
{% block content %}

<style>
  /* Keeps doughnuts perfectly circular and centered */
  .chart-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    aspect-ratio: 1 / 1;
  }

  canvas {
    width: 100% !important;
    height: auto !important;
  }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">ğŸ“Š HAESSA Component Analytics</h2>
    <button id="download-pdf" class="btn btn-danger">â¬‡ï¸ Download PDF Report</button>
  </div>

  <div class="alert text-center shadow-sm fw-bold mb-3 {{ summary_color }}" role="alert">
    {{ performance_summary }}
  </div>

  <div class="progress mb-4" style="height: 22px;" title="{{ progress_tooltip }}">
    <div
      class="progress-bar {{ summary_color }}"
      role="progressbar"
      style="width: {{ performance_pct }}%;"
      aria-valuenow="{{ performance_pct }}"
      aria-valuemin="0"
      aria-valuemax="100"
    >
      {{ performance_pct }}%
    </div>
  </div>

  <!-- Overall Chart -->
  <div class="row justify-content-center mb-4">
    <div class="col-md-6 text-center">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold">ğŸ—ï¸ Overall Component Status</h5>
          <div class="chart-container"><canvas id="overallChart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Per-Coach Doughnuts -->
  <div class="row">
    {% for c in chart_data %}
    <div class="col-md-6 text-center mb-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3">ğŸš† Coach {{ c.coach }}</h5>
          <div class="chart-container"><canvas id="chart_{{ loop.index }}"></canvas></div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Trend Charts -->
  <div class="row mt-4">
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold text-center">ğŸ“ˆ Monthly Delivery Trends</h5>
          <canvas id="monthlyTrend" height="240"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold text-center">ğŸ“† Weekly Performance</h5>
          <canvas id="weeklyTrend" height="240"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="text-muted text-center mt-5 small">
    <p>Generated by <strong>{{ generated_by }}</strong> on {{ generated_at }}</p>
  </div>
</div>

<!-- âœ… Chart.js + DataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  Chart.register(ChartDataLabels);

  // ğŸŸ¢ Corrected Center Text Plugin for Chart.js v4
  const centerTextPlugin = {
    id: 'centerTextPlugin',
    afterDraw(chart) {
      const { ctx, chartArea } = chart;
      const total = chart.config.options.plugins.totalText;
      if (!total) return;

      const meta = chart.getDatasetMeta(0);
      if (!meta || !meta.data.length) return;

      const firstArc = meta.data[0];
      const cx = firstArc.x;
      const cy = firstArc.y;

      ctx.save();
      ctx.font = "bold 16px Arial";
      ctx.fillStyle = "#111";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(`Total: ${total}`, cx, cy);
      ctx.restore();
    }
  };

  Chart.register(centerTextPlugin);

  // Common doughnut chart options
  const doughnutOpts = (title, total) => ({
    type: "doughnut",
    options: {
      maintainAspectRatio: true,
      aspectRatio: 1,
      cutout: "65%",
      plugins: {
        legend: { position: "bottom" },
        title: { display: true, text: title },
        datalabels: {
          color: "#111",
          font: { weight: "bold", size: 11 },
          formatter: (value, ctx) => {
            const data = ctx.chart.data.datasets[0].data;
            const sum = data.reduce((a, b) => a + b, 0);
            const pct = ((value / sum) * 100).toFixed(1) + "%";
            return pct;
          }
        },
        totalText: total
      }
    },
    plugins: [ChartDataLabels, centerTextPlugin]
  });

  // âœ… Overall Chart
  new Chart(document.getElementById("overallChart"), {
    type: "doughnut",
    data: {
      labels: {{ overall_chart['labels']|tojson }},
      datasets: [{
        data: {{ overall_chart['values']|tojson }},
        backgroundColor: ["#198754", "#ffc107", "#dc3545", "#0dcaf0", "#36a2eb", "#8bc34a"],
        borderWidth: 1
      }]
    },
    options: doughnutOpts(`Overall Status (Total: {{ overall_chart['total'] }})`, {{ overall_chart['total'] }})
  });

  // âœ… Per-Coach Doughnuts
  {% for c in chart_data %}
  new Chart(document.getElementById("chart_{{ loop.index }}"), {
    type: "doughnut",
    data: {
      labels: {{ c['labels']|tojson }},
      datasets: [{
        data: {{ c['values']|tojson }},
        backgroundColor: ["#198754", "#ffc107", "#dc3545", "#36a2eb", "#8bc34a"],
        borderWidth: 1
      }]
    },
    options: doughnutOpts(`Coach {{ c['coach'] }} (Total: {{ c['total'] }})`, {{ c['total'] }})
  });
  {% endfor %}

  // âœ… Monthly Trend
  new Chart(document.getElementById("monthlyTrend"), {
    type: "line",
    data: {
      labels: {{ trend_data['labels']|tojson }},
      datasets: [
        { label: "On Time", data: {{ trend_data['monthly']['On Time']|tojson }}, borderColor: "#198754", tension: 0.3 },
        { label: "Late", data: {{ trend_data['monthly']['Late']|tojson }}, borderColor: "#dc3545", tension: 0.3 }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } }, scales: { y: { beginAtZero: true } } }
  });

  // âœ… Weekly Trend
  new Chart(document.getElementById("weeklyTrend"), {
    type: "bar",
    data: {
      labels: ["Week 1", "Week 2", "Week 3", "Week 4"],
      datasets: [
        { label: "On Time", data: {{ trend_data['weekly']['On Time']|tojson }}, backgroundColor: "#198754" },
        { label: "Late", data: {{ trend_data['weekly']['Late']|tojson }}, backgroundColor: "#dc3545" }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } }, scales: { y: { beginAtZero: true } } }
  });

  // âœ… PDF Download
  document.getElementById("download-pdf").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "pt", "a4");
    const container = document.querySelector(".container");
    const canvas = await html2canvas(container, { scale: 2 });
    const img = canvas.toDataURL("image/png");
    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;
    pdf.text("HAESSA Analytics Report", w / 2, 30, { align: "center" });
    pdf.addImage(img, "PNG", 0, 40, w, h);
    pdf.text(`Generated by {{ generated_by }} on {{ generated_at }}`, 40, h + 60);
    pdf.save("HAESSA_Analytics_Report.pdf");
  });
});
</script>

{% endblock %}
