{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <!-- HEADER -->
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary mb-2">HAESSA_CTED Component Analytics Report</h2>
    <p class="text-muted mb-1">Generated by <strong>{{ generated_by }}</strong></p>
    <p class="text-muted mb-1">Date: <strong>{{ generated_at }}</strong></p>
    <p class="text-muted">Total Coaches: <strong>{{ total_coaches }}</strong></p>

    {% if show_alert %}
    <div class="alert alert-danger d-inline-block px-4 py-2 mt-3">
      ‚ö†Ô∏è <strong>Current Period On-Time: {{ "%.1f"|format(current_period_pct) }}%</strong> ‚Äî Below 90% Target!
    </div>
    {% endif %}

    <div class="btn-group mt-3">
      <button id="downloadPDF" class="btn btn-outline-danger">‚¨áÔ∏è PDF Report</button>
      <button id="exportExcel" class="btn btn-outline-success">üìä Export to Excel</button>
    </div>
  </div>
  <hr class="my-4">

  <!-- TABS -->
  <ul class="nav nav-tabs mb-4" id="analyticsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overall-tab" data-bs-toggle="tab" data-bs-target="#overall-content" type="button">Overall & Coaches</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="supplier-tab" data-bs-toggle="tab" data-bs-target="#supplier-content" type="button">Supplier Performance</button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- OVERALL & COACHES -->
    <div class="tab-pane fade show active" id="overall-content">
      <div id="coach-charts">
        {% for chart in chart_data %}
        <div class="card shadow-sm mb-5 report-section coach-card" style="cursor: pointer;" 
             data-coach="{{ chart.coach }}" data-components='{{ chart.components | tojson }}'>
          <div class="card-body text-center">
            <h3 class="fw-bold text-secondary mb-3">Coach {{ chart.coach }}</h3>
            <div class="d-flex justify-content-center">
              <div class="chart-container mx-auto" style="max-width:520px;height:420px;">
                <canvas id="chart-{{ loop.index }}"></canvas>
              </div>
              <div id="callouts-{{ loop.index }}" class="callouts-box ms-3"></div>
            </div>
            <p class="mt-3 mb-0 text-muted">Total Components: <strong>{{ chart.total }}</strong></p>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- OVERALL SUMMARY -->
      <div class="card shadow-sm mb-5 report-section">
        <div class="card-body text-center">
          <h3 class="fw-bold text-success mb-3">Overall HAESSA Summary</h3>
          <div class="d-flex justify-content-center">
            <div class="chart-container mx-auto" style="max-width:520px;height:420px;">
              <canvas id="overallChart"></canvas>
            </div>
            <div id="callouts-overall" class="callouts-box ms-3"></div>
          </div>
          <p class="mt-3 mb-0 text-muted">Total Components: <strong>{{ overall_chart.total }}</strong></p>
        </div>
      </div>

      <!-- TREND -->
      <div class="card mb-5 shadow mx-auto report-section" style="max-width: 1000px;">
        <div class="card-body text-center">
          <h4 class="mb-4 text-primary fw-bold">On-Time Delivery Trend</h4>
          <div class="row justify-content-center mb-4">
            <div class="col-6 col-md-3">
              <select id="trendPeriod" class="form-select">
                <option value="daily">Daily (Last 30 Days)</option>
                <option value="weekly">Weekly (Last 12 Weeks)</option>
                <option value="monthly" selected>Monthly (Last 12 Months)</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
          </div>
          <div class="chart-wrapper mx-auto" style="max-width:940px;height:500px;">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- SUPPLIER TAB -->
    <div class="tab-pane fade" id="supplier-content">
      <div class="card shadow-sm mb-5">
        <div class="card-body">
          <h4 class="text-center mb-4">Supplier On-Time Delivery Trend (Monthly)</h4>
          <div class="chart-wrapper mx-auto" style="max-width:940px;height:500px;">
            <canvas id="supplierTrendChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DRILL-DOWN MODAL -->
<div class="modal fade" id="coachModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Components - Coach <span id="modalCoach"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="componentsTable">
            <thead class="table-dark">
              <tr>
                <th>Item No</th>
                <th>Component</th>
                <th>Supplier</th>
                <th>Quantity</th>
                <th>Lead Time (days)</th>
                <th>CTED Due Date</th>
                <th>Status</th>
                <th>Order Recommendation</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.chart-container { width: 520px; height: 420px; }
.chart-wrapper { width: 100%; }
.callouts-box { max-width: 300px; text-align: left; margin-left: 12px; }
.callout-item { display:flex; align-items:center; gap:10px; margin:6px 0; font-size:0.86rem; }
.callout-color { width:14px; height:14px; border-radius:3px; flex-shrink:0; }
.coach-card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.15); transform: translateY(-2px); transition: all 0.3s; }
.lead-time-high { background-color: #fff3cd !important; }
.recommend-order { color: #dc3545; font-weight: bold; }
@media print {
  .report-section { page-break-before: always; page-break-inside: avoid; }
  #downloadPDF, .btn-group, .nav-tabs, #exportExcel { display:none !important; }
  .chart-wrapper { height: 480px !important; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const chartData = {{ chart_data | tojson }};
  const overallChart = {{ overall_chart | tojson }};
  const dailyLabels = {{ daily_labels | tojson }};
  const dailyValues = {{ daily_values | tojson }};
  const weeklyLabels = {{ weekly_labels | tojson }};
  const weeklyValues = {{ weekly_values | tojson }};
  const monthlyLabels = {{ monthly_labels | tojson }};
  const monthlyValues = {{ monthly_values | tojson }};
  const supplierData = {{ supplier_chart_data | tojson }};

  const COLORS = ["#dc3545","#ffc107","#17a2b8","#28a745","#007bff","#6610f2","#6f42c1","#fd7e14","#20c997","#e83e8c"];

  // Register plugins
  Chart.register(ChartDataLabels);

  const centerTotalPlugin = {
    id: 'centerTotal',
    afterDraw(chart) {
      if (chart.config.type !== 'doughnut') return;
      const total = chart.data.datasets[0].data.reduce((a,b) => a + b, 0);
      const {ctx, chartArea} = chart;
      const x = (chartArea.left + chartArea.right) / 2;
      const y = (chartArea.top + chartArea.bottom) / 2;
      ctx.save();
      ctx.font = '700 22px "Segoe UI", Roboto, sans-serif';
      ctx.fillStyle = '#222';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(total, x, y);
      ctx.restore();
    }
  };
  Chart.register(centerTotalPlugin);

  function doughnutOptions(total) {
    return {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '62%',
      plugins: {
        datalabels: { display: false },
        legend: { display: false },
        tooltip: {
          callbacks: { label: ctx => {
            const v = ctx.parsed;
            const pct = total ? ((v / total) * 100).toFixed(1) : '0.0';
            return ctx.label + ': ' + v + ' (' + pct + '%)';
          }}
        }
      }
    };
  }

  function renderCallouts(el, labels, values, total, colors) {
    if (!el) return;
    el.innerHTML = '';
    labels.forEach((lbl, i) => {
      const val = values[i] || 0;
      const pct = total ? ((val / total) * 100).toFixed(1) : '0.0';
      el.innerHTML += `<div class="callout-item">
        <span class="callout-color" style="background:${colors[i] || '#ccc'}"></span>
        <div><strong style="font-size:0.95rem">${lbl}</strong><br>
          <span style="color:#666;font-size:0.85rem">${val} ‚Äî ${pct}%</span>
        </div>
      </div>`;
    });
  }

  // DRAW DOUGHNUTS
  chartData.forEach((ch, idx) => {
    const id = idx + 1;
    const ctx = document.getElementById(`chart-${id}`);
    if (ctx) {
      const total = ch.total;
      new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ch.labels, datasets: [{ data: ch.values, backgroundColor: COLORS.slice(0, ch.labels.length) }] },
        options: doughnutOptions(total),
        plugins: [centerTotalPlugin]
      });
      renderCallouts(document.getElementById(`callouts-${id}`), ch.labels, ch.values, total, COLORS);
    }
  });

  // Overall
  const overallCtx = document.getElementById('overallChart');
  if (overallCtx) {
    const total = overallChart.total;
    new Chart(overallCtx, {
      type: 'doughnut',
      data: { labels: overallChart.labels, datasets: [{ data: overallChart.values, backgroundColor: COLORS.slice(0, overallChart.labels.length) }] },
      options: doughnutOptions(total),
      plugins: [centerTotalPlugin]
    });
    renderCallouts(document.getElementById('callouts-overall'), overallChart.labels, overallChart.values, total, COLORS);
  }

  // UNREGISTER DATALABELS BEFORE LINE CHARTS
  Chart.unregister(ChartDataLabels);

  // TREND CHART
  let trendChart = null;
  function drawTrend(labels, values) {
    const ctx = document.getElementById('trendChart');
    if (!ctx || trendChart) trendChart?.destroy();

    const avg = values.reduce((a,b) => a + b, 0) / values.length || 0;

    const n = values.length;
    const x = Array.from({length: n}, (_, i) => i);
    const sumX = x.reduce((a,b) => a + b, 0);
    const sumY = values.reduce((a,b) => a + b, 0);
    const sumXY = x.reduce((a, b, i) => a + b * values[i], 0);
    const sumX2 = x.reduce((a,b) => a + b*b, 0);
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX) || 0;
    const intercept = (sumY - slope * sumX) / n;

    const forecastLabels = ['Next', 'Next+1', 'Next+2'];
    const forecastValues = forecastLabels.map((_, i) => Math.max(0, Math.min(100, intercept + slope * (n + i + 1))));

    trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [...labels, ...forecastLabels],
        datasets: [
          { label: 'On Time (%)', data: [...values, null, null, null], borderColor: ctx => (ctx.parsed?.y >= 90 ? '#28a745' : '#dc3545'), backgroundColor: ctx => (ctx.parsed?.y >= 90 ? '#28a74522' : '#dc354522'), fill: true, tension: 0.3, pointRadius: 6 },
          { label: `Average (${avg.toFixed(1)}%)`, data: Array(labels.length + 3).fill(avg), borderColor: '#ffc107', borderDash: [6,4], pointRadius: 0 },
          { label: 'Target (90%)', data: Array(labels.length + 3).fill(90), borderColor: '#dc3545', borderDash: [8,5], pointRadius: 0 },
          { label: 'Forecast', data: [null,null,null,...forecastValues], borderColor: '#6f42c1', borderDash: [10,5], fill: false, pointRadius: 7, pointStyle: 'triangle' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v.toFixed(1) + '%' } } },
        plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%` } } }
      }
    });
  }

  drawTrend(monthlyLabels, monthlyValues);

  document.getElementById('trendPeriod')?.addEventListener('change', e => {
    const p = e.target.value;
    let l, v;
    if (p === 'daily') { l = dailyLabels; v = dailyValues; }
    else if (p === 'weekly') { l = weeklyLabels; v = weeklyValues; }
    else if (p === 'monthly') { l = monthlyLabels; v = monthlyValues; }
    else if (p === 'quarterly') {
      l = ['Q1','Q2','Q3','Q4'];
      v = [];
      for (let i = 0; i < 12; i += 3) v.push((monthlyValues.slice(i,i+3).reduce((a,b)=>a+b,0)/(monthlyValues.slice(i,i+3).length||1)).toFixed(1));
      v = v.map(Number);
    } else {
      const avg = monthlyValues.reduce((a,b)=>a+b,0)/monthlyValues.length || 0;
      l = ['Year']; v = [avg.toFixed(1)];
    }
    drawTrend(l, v);
  });

  // SUPPLIER CHART
  let supplierChart = null;
  function drawSupplierTrend() {
    const ctx = document.getElementById('supplierTrendChart');
    if (!ctx) return;
    if (supplierChart) supplierChart.destroy();
    const datasets = supplierData.map((s, i) => ({
      label: s.supplier,
      data: s.values,
      borderColor: COLORS[i % COLORS.length],
      backgroundColor: COLORS[i % COLORS.length] + '22',
      tension: 0.3,
      fill: false
    }));
    supplierChart = new Chart(ctx, {
      type: 'line',
      data: { labels: monthlyLabels, datasets },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 100, ticks: { callback: v => v.toFixed(1) + '%' } } } }
    });
  }

  document.getElementById('supplier-tab').addEventListener('shown.bs.tab', drawSupplierTrend);

  // DRILL-DOWN & EXCEL (placeholder for now)
  // ... add when ready

  // PDF & live refresh
  document.getElementById('downloadPDF').addEventListener('click', () => { /* your existing code */ });
  setInterval(() => location.reload(), 60000);
  const liveIndicator = document.createElement('div');
  liveIndicator.innerHTML = 'Live (refreshes every 60s)';
  liveIndicator.style.cssText = 'position:fixed;bottom:20px;right:20px;background:rgba(40,167,69,0.9);color:white;padding:10px 15px;border-radius:25px;font-size:13px;z-index:9999;';
  document.body.appendChild(liveIndicator);
});
</script>
{% endblock %}