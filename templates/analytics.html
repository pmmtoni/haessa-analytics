{% extends "base.html" %}
{% block content %}

<div class="container py-4">

  <!-- HEADER -->
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary mb-2">HAESSA Component Analytics Report</h2>
    <p class="text-muted mb-1">Generated by <strong>{{ generated_by }}</strong></p>
    <p class="text-muted mb-1">Date: <strong>{{ generated_at }}</strong></p>
    <p class="text-muted">Total Coaches: <strong>{{ total_coaches }}</strong></p>

    <button id="downloadPDF" class="btn btn-outline-danger mt-2">
      ‚¨áÔ∏è Download Analytics Report (PDF)
    </button>
  </div>

  <hr class="my-4">

  <!-- COACH DONUT CHARTS -->
  {% for chart in chart_data %}
  <div class="card shadow-sm mb-5 text-center report-section">
    <div class="card-body">
      <h3 class="fw-bold text-secondary mb-3">üöÜ Coach {{ chart.coach }}</h3>
      <div class="chart-container mx-auto">
        <canvas id="chart-{{ loop.index }}"></canvas>
      </div>
      <p class="mt-3 mb-0 text-muted">Total Components: <strong>{{ chart.total }}</strong></p>
    </div>
  </div>
  {% endfor %}

  <!-- OVERALL SUMMARY -->
  <div class="text-center mb-5 report-section">
    <h3 class="fw-bold text-success mb-3">üìä Overall HAESSA Summary</h3>
    <div class="chart-container mx-auto">
      <canvas id="overallChart"></canvas>
    </div>
    <p class="mt-3 mb-0 text-muted">Total Components: <strong>{{ overall_chart.total }}</strong></p>
  </div>

  <!-- üìà DELIVERY PERFORMANCE TREND -->
  <div class="card mb-4 shadow mx-auto report-section" style="max-width: 900px;">
    <div class="card-body text-center">
      <h4 class="mb-3 text-primary fw-bold">üìà Delivery Performance Trend</h4>

      <div class="row justify-content-center mb-4">
        <div class="col-md-3">
          <label class="form-label fw-bold">Trend Period:</label>
          <select id="trendPeriod" class="form-select">
            <option value="monthly" selected>Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="quarterly">Quarterly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Metric:</label>
          <select id="trendMetric" class="form-select">
            {% for metric in trend_metrics %}
              <option value="{{ metric }}" {% if loop.first %}selected{% endif %}>{{ metric }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="chart-wrapper">
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </div>
</div>

<style>
.chart-container { position: relative; width: 100%; max-width: 600px; margin: auto; }
.chart-wrapper { position: relative; width: 80%; max-width: 900px; margin: auto; }
.card { border-radius: 15px; }
canvas { min-height: 300px; }
@media print {
  .report-section { page-break-before: always; page-break-inside: avoid; }
  #downloadPDF { display: none; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const colors = ["#dc3545","#ffc107","#17a2b8","#28a745","#007bff","#6610f2","#6f42c1"];

  // === Center Text Plugin ===
  const centerTextPlugin = {
    id: 'centerText',
    afterDraw(chart) {
      const { ctx, chartArea } = chart;
      const dataset = chart.data.datasets[0];
      if (!dataset || !dataset.data) return;
      const total = dataset.data.reduce((a,b)=>a+b,0);
      const centerX = (chartArea.left + chartArea.right) / 2;
      const centerY = (chartArea.top + chartArea.bottom) / 2;

      ctx.save();
      ctx.font = `bold ${Math.max(chartArea.width * 0.06, 16)}px Segoe UI`;
      ctx.fillStyle = '#222';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(total, centerX, centerY);
      ctx.restore();
    }
  };

  // === Improved Callout Lines + Smart % Labels Plugin ===
  const calloutLabelPlugin = {
    id: 'calloutLabel',
    afterDatasetsDraw(chart) {
      const { ctx } = chart;
      const meta = chart.getDatasetMeta(0);
      if (!meta || !meta.data.length) return;

      const data = chart.data.datasets[0].data;
      const total = data.reduce((a,b)=>a+b,0);
      const arcs = meta.data;

      // Collect label positions first
      const labels = [];
      arcs.forEach((arc, i) => {
        const value = data[i];
        if (!value) return;
        const pct = ((value / total) * 100).toFixed(1) + "%";
        const props = arc.getProps(['startAngle','endAngle','outerRadius','x','y'], true);
        const angle = (props.startAngle + props.endAngle) / 2;
        const radius = props.outerRadius;

        const x1 = props.x + Math.cos(angle) * (radius * 1.1);
        const y1 = props.y + Math.sin(angle) * (radius * 1.1);
        const x2 = x1 + (Math.cos(angle) > 0 ? 25 : -25);

        labels.push({
          pct,
          angle,
          x1, y1,
          x2,
          align: Math.cos(angle) > 0 ? "left" : "right"
        });
      });

      // Adjust labels to prevent vertical overlap
      const minGap = 14; // pixels
      labels.sort((a,b) => a.y1 - b.y1);
      for (let i = 1; i < labels.length; i++) {
        const prev = labels[i - 1];
        const curr = labels[i];
        if (Math.abs(curr.y1 - prev.y1) < minGap) {
          const offset = minGap - Math.abs(curr.y1 - prev.y1);
          labels[i].y1 += (curr.y1 > prev.y1 ? offset : -offset);
        }
      }

      // Draw lines and labels
      ctx.save();
      ctx.font = "bold 12px Segoe UI";
      ctx.fillStyle = "#222";
      ctx.lineWidth = 1;
      ctx.strokeStyle = "rgba(0,0,0,0.4)";

      labels.forEach(label => {
        const radius = meta.data[0].outerRadius;
        const center = meta.data[0];
        const x0 = center.x + Math.cos(label.angle) * (radius * 0.9);
        const y0 = center.y + Math.sin(label.angle) * (radius * 0.9);

        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(label.x1, label.y1);
        ctx.lineTo(label.x2, label.y1);
        ctx.stroke();

        ctx.textAlign = label.align;
        ctx.fillText(label.pct, label.x2 + (label.align === "left" ? 5 : -5), label.y1 + 4);
      });
      ctx.restore();
    }
  };

  // Register plugins
  Chart.register(centerTextPlugin, calloutLabelPlugin);

  // === Donut Options ===
  const donutOpts = total => ({
    responsive: true,
    maintainAspectRatio: false,
    cutout: "65%",
    layout: { padding: 20 },
    plugins: {
      legend: { position: "right", labels: { boxWidth: 14, padding: 18 } },
      tooltip: {
        callbacks: {
          label: ctx => `${ctx.label}: ${ctx.parsed} (${((ctx.parsed / total) * 100).toFixed(1)}%)`
        }
      }
    }
  });

  // === Donut Charts per Coach ===
  {% for chart in chart_data %}
  new Chart(document.getElementById("chart-{{ loop.index }}"), {
    type: "doughnut",
    data: {
      labels: {{ chart['labels'] | tojson | safe }},
      datasets: [{
        data: {{ chart['values'] | tojson | safe }},
        backgroundColor: colors.slice(0, {{ chart['labels']|length }}),
        borderColor: "#fff",
        borderWidth: 2
      }]
    },
    options: donutOpts({{ chart.total }}),
    plugins: [centerTextPlugin, calloutLabelPlugin]
  });
  {% endfor %}

  // === Overall Summary Donut ===
  new Chart(document.getElementById("overallChart"), {
    type: "doughnut",
    data: {
      labels: {{ overall_chart['labels'] | tojson | safe }},
      datasets: [{
        data: {{ overall_chart['values'] | tojson | safe }},
        backgroundColor: colors.slice(0, {{ overall_chart['labels']|length }}),
        borderColor: "#fff",
        borderWidth: 2
      }]
    },
    options: donutOpts({{ overall_chart.total }}),
    plugins: [centerTextPlugin, calloutLabelPlugin]
  });

  // === Trend Chart with 90% Threshold ===
  const trendData = {{ trend_data | tojson | safe }};
  const periodLabels = {
    "weekly":["W1","W2","W3","W4"],
    "monthly":["May","Jun","Jul","Aug","Sep","Oct"],
    "quarterly":["Q1","Q2","Q3","Q4"],
    "yearly":["2021","2022","2023","2024","2025"]
  };
  let trendChart;
  const trendCtx=document.getElementById("trendChart");

  function drawTrendChart(metric, period) {
    const labels = periodLabels[period];
    const data = (trendData[period] && trendData[period][metric]) ? trendData[period][metric] : [];
    if (trendChart) trendChart.destroy();

    trendChart = new Chart(trendCtx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: `${metric} (${period})`,
            data: data,
            borderColor: "#007bff",
            borderWidth: 2,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: "#007bff",
            fill: false
          },
          {
            label: "Threshold (90%)",
            data: new Array(labels.length).fill(90),
            borderColor: "red",
            borderWidth: 2,
            borderDash: [6,6],
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        aspectRatio: 1.5,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: "Performance (%)" }
          }
        },
        plugins: { legend: { position: "top" } }
      }
    });
  }

  drawTrendChart(document.getElementById("trendMetric").value, document.getElementById("trendPeriod").value);
  document.getElementById("trendMetric").addEventListener("change", e => {
    drawTrendChart(e.target.value, document.getElementById("trendPeriod").value);
  });
  document.getElementById("trendPeriod").addEventListener("change", e => {
    drawTrendChart(document.getElementById("trendMetric").value, e.target.value);
  });

  // === PDF Download ===
  document.getElementById("downloadPDF").addEventListener("click", () => {
    const element = document.querySelector(".container");
    const opt = {
      margin: [0.3, 0.3, 0.5, 0.3],
      filename: `HAESSA_Analytics_Report_{{ generated_at|replace(':','-') }}.pdf`,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 1.8, useCORS: true, scrollY: 0 },
      jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
      pagebreak: { mode: ["avoid-all", "css", "legacy"] }
    };
    html2pdf().from(element).set(opt).save();
  });
});
</script>

{% endblock %}
