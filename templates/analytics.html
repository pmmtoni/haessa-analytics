{% extends "base.html" %}
{% block content %}

<div class="container py-4">

  <!-- HEADER -->
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary mb-2">HAESSA Component Analytics Report</h2>
    <p class="text-muted mb-1">Generated by <strong>{{ generated_by }}</strong></p>
    <p class="text-muted mb-1">Date: <strong>{{ generated_at }}</strong></p>
    <p class="text-muted">Total Coaches: <strong>{{ total_coaches }}</strong></p>

    <button id="downloadPDF" class="btn btn-outline-danger mt-2">
      ‚¨áÔ∏è Download Analytics Report (PDF)
    </button>
  </div>

  <hr class="my-4">

  <!-- COACH CHARTS: one card per coach -->
  <div id="coach-charts">
    {% for chart in chart_data %}
    <div class="card shadow-sm mb-5 report-section">
      <div class="card-body text-center">
        <h3 class="fw-bold text-secondary mb-3">üöÜ Coach {{ chart.coach }}</h3>

        <div class="d-flex justify-content-center">
          <div class="chart-container mx-auto" style="max-width:520px;height:420px;">
            <canvas id="chart-{{ loop.index }}"></canvas>
          </div>

          <!-- Callouts (outside, readable) -->
          <div id="callouts-{{ loop.index }}" class="callouts-box ms-3"></div>
        </div>

        <p class="mt-3 mb-0 text-muted">Total Components: <strong>{{ chart.total }}</strong></p>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- OVERALL SUMMARY -->
  <div class="card shadow-sm mb-5 report-section">
    <div class="card-body text-center">
      <h3 class="fw-bold text-success mb-3">üìä Overall HAESSA Summary</h3>

      <div class="d-flex justify-content-center">
        <div class="chart-container mx-auto" style="max-width:520px;height:420px;">
          <canvas id="overallChart"></canvas>
        </div>

        <div id="callouts-overall" class="callouts-box ms-3"></div>
      </div>

      <p class="mt-3 mb-0 text-muted">Total Components: <strong>{{ overall_chart["total"] }}</strong></p>
    </div>
  </div>

  <!-- TREND LINE -->
  <div class="card mb-4 shadow mx-auto report-section" style="max-width: 920px;">
    <div class="card-body text-center">
      <h4 class="mb-3 text-primary fw-bold">üìà On-Time Delivery Trend (by CTED due date)</h4>

      <div class="row justify-content-center mb-3">
        <div class="col-6 col-md-3">
          <select id="trendPeriod" class="form-select">
            <option value="monthly" selected>Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>
      </div>

      <div class="chart-wrapper mx-auto" style="max-width:860px;">
        <canvas id="trendChart" height="160"></canvas>
      </div>
    </div>
  </div>

</div>

<!-- STYLES -->
<style>
.chart-container { width: 520px; height: 420px; }
.chart-wrapper { width: 100%; }
.callouts-box {
  max-width: 300px;
  text-align: left;
  margin-left: 12px;
}
.callout-item {
  display:flex; align-items:center; gap:10px; margin:6px 0; font-size:0.86rem;
}
.callout-color { width:14px; height:14px; border-radius:3px; flex-shrink:0; }
@media print {
  .report-section { page-break-before: always; page-break-inside: avoid; }
  #downloadPDF { display:none; }
}
</style>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Data coming from server-side Jinja -> safe JSON lists/objects
  const chartData = {{ chart_data | tojson }};
  const overallChart = {{ overall_chart | tojson }};
  const monthlyLabelsServer = {{ monthly_labels | tojson }};
  const monthlyValuesServer = {{ monthly_values | tojson }};

  // Color palette (keeps consistent across charts)
  const COLORS = ["#dc3545","#ffc107","#17a2b8","#28a745","#007bff","#6610f2","#6f42c1"];

  // Register plugins
  Chart.register(ChartDataLabels);

  // Center total plugin (draws number in middle)
  const centerTotalPlugin = {
    id: 'centerTotal',
    afterDraw(chart) {
      const {ctx, chartArea} = chart;
      if (chart.config.type !== 'doughnut') return;
      const total = chart.data.datasets[0].data.reduce((a,b) => a + b, 0);
      const x = (chartArea.left + chartArea.right) / 2;
      const y = (chartArea.top + chartArea.bottom) / 2;
      ctx.save();
      ctx.font = '700 22px "Segoe UI", Roboto, sans-serif';
      ctx.fillStyle = '#222';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(total, x, y);
      ctx.restore();
    }
  };
  Chart.register(centerTotalPlugin);

  // Doughnut options factory (external small percent labels are in callouts)
  function doughnutOptions(total) {
    return {
      type: 'doughnut',
      data: {},
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '62%',
        plugins: {
          datalabels: {
            display: false // hide inside labels (we use external callouts)
          },
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const v = context.parsed;
                const pct = total ? ((v / total) * 100).toFixed(1) : '0.0';
                return context.label + ': ' + v + ' (' + pct + '%)';
              }
            }
          }
        }
      }
    };
  }

  // Helper: create callouts box content
  function renderCallouts(containerEl, labels, values, total, colorArr) {
    containerEl.innerHTML = '';
    labels.forEach((lbl, i) => {
      const val = values[i] || 0;
      const pct = total ? ((val / total) * 100).toFixed(1) : '0.0';
      const item = document.createElement('div');
      item.className = 'callout-item';
      item.innerHTML = `
        <span class="callout-color" style="background:${colorArr[i] || '#ccc'}"></span>
        <div><strong style="font-size:0.95rem">${lbl}</strong><br><span style="color:#666;font-size:0.85rem">${val} ‚Äî ${pct}%</span></div>
      `;
      containerEl.appendChild(item);
    });
  }

  // Create coach charts and callouts
  chartData.forEach((ch, idx) => {
    const id = idx + 1;
    const ctx = document.getElementById(`chart-${id}`);
    if (!ctx) return; // safety
    const total = ch.total || ch.values.reduce((a,b)=>a+b,0);
    const cfg = {
      type: 'doughnut',
      data: {
        labels: ch.labels,
        datasets: [{
          data: ch.values,
          backgroundColor: COLORS.slice(0, ch.labels.length)
        }]
      },
      options: doughnutOptions(total).options,
      plugins: [centerTotalPlugin]
    };
    // draw chart
    new Chart(ctx, cfg);

    // populate external callouts
    const calloutEl = document.getElementById(`callouts-${id}`);
    if (calloutEl) renderCallouts(calloutEl, ch.labels, ch.values, total, COLORS);
  });

  // Overall chart + callouts
  (function buildOverall(){
    const ctx = document.getElementById('overallChart');
    if (!ctx) return;
    const total = overallChart.total || overallChart.values.reduce((a,b)=>a+b,0);
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: overallChart.labels,
        datasets: [{ data: overallChart.values, backgroundColor: COLORS.slice(0, overallChart.labels.length) }]
      },
      options: doughnutOptions(total).options,
      plugins: [centerTotalPlugin]
    });
    const calloutOverall = document.getElementById('callouts-overall');
    if (calloutOverall) renderCallouts(calloutOverall, overallChart.labels, overallChart.values, total, COLORS);
  })();

  // Trend chart (monthly by CTED_due_date ‚Äî server provided)
  let trendChart = null;
  function drawTrend(labels, values) {
    const ctx = document.getElementById('trendChart');
    if (!ctx) return;
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'On Time (%)',
          data: values,
          borderColor: '#28a745',
          backgroundColor: '#28a74522',
          fill: true,
          tension: 0.25,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero:true, max:100, ticks:{callback: v => v + '%'} } },
        plugins: { legend: { display: false } }
      }
    });
  }

  // initial trend (server-sent monthlyLabelsServer/monthlyValuesServer)
  drawTrend(monthlyLabelsServer, monthlyValuesServer);

  // For simple switching, we only have monthly/quarterly/yearly prepared on backend.
  document.getElementById('trendPeriod')?.addEventListener('change', (e) => {
    const period = e.target.value;
    // backend prepared arrays: we included monthly only; for quarterly/yearly we fallback to aggregated monthly.
    if (period === 'monthly') drawTrend(monthlyLabelsServer, monthlyValuesServer);
    else if (period === 'quarterly') {
      // aggregate monthlyValuesServer into quarters (simple chunking)
      const m = monthlyValuesServer.slice(); // copy
      const quarters = [];
      const labels = [];
      for (let i = 0; i < m.length; i += 3) {
        const chunk = m.slice(i, i+3);
        if (chunk.length === 0) continue;
        const sum = chunk.reduce((a,b)=>a+b,0);
        const avg = +(sum / chunk.length).toFixed(1);
        quarters.push(avg);
        labels.push(`Q${(i/3)+1}`);
      }
      drawTrend(labels, quarters);
    } else if (period === 'yearly') {
      // collapse to 1 yearly average
      const sum = monthlyValuesServer.reduce((a,b)=>a+b,0);
      const avg = +(sum / monthlyValuesServer.length).toFixed(1);
      drawTrend(['Year'], [avg]);
    }
  });

  // PDF export: make each report-section full-page-ish to avoid splitting charts
  document.getElementById('downloadPDF').addEventListener('click', function(){
    document.querySelectorAll('.report-section').forEach((el) => {
      el.style.minHeight = '950px';
      el.style.padding = '30px';
    });
    const opt = {
      margin:       0.35,
      filename:     `HAESSA_Analytics_Report_{{ generated_at|replace(':','-') }}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 1.8, useCORS: true, scrollY: 0 },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' },
      pagebreak:    { mode: ['css', 'legacy'] }
    };
    html2pdf().from(document.querySelector('.container')).set(opt).save().then(()=> {
      // cleanup styles we added
      document.querySelectorAll('.report-section').forEach((el) => {
        el.style.minHeight = '';
        el.style.padding = '';
      });
    });
  });

});
</script>

{% endblock %}
