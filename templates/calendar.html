{% extends "base.html" %}
{% block content %}

<h3 class="fw-bold mb-3">Component Calendar</h3>

<!-- Summary Cards -->
<div class="row mb-3">

  <div class="col-md-3">
    <div class="card text-bg-primary shadow-sm">
      <div class="card-body py-2">
        <h5 class="card-title mb-1">Total Components</h5>
        <p class="card-text fs-4">{{ summary.total }}</p>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card text-bg-danger shadow-sm">
      <div class="card-body py-2">
        <h5 class="card-title mb-1">Overdue</h5>
        <p class="card-text fs-4">{{ summary.overdue }}</p>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card text-bg-success shadow-sm">
      <div class="card-body py-2">
        <h5 class="card-title mb-1">Delivered</h5>
        <p class="card-text fs-4">{{ summary.delivered }}</p>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card text-bg-secondary shadow-sm">
      <div class="card-body py-2">
        <h5 class="card-title mb-1">Pending</h5>
        <p class="card-text fs-4">{{ summary.pending }}</p>
      </div>
    </div>
  </div>

</div>

<!-- FullCalendar CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.css" rel="stylesheet">

<!-- Calendar Container -->
<div id="calendar" class="card shadow-sm p-3"></div>

<hr class="my-4">

<h4 class="fw-bold">ðŸ“Œ Daily Summary â€“ CTED Due Today</h4>

<div id="daily-summary" class="mt-3">
    <p class="text-muted">Loading today's due itemsâ€¦</p>
</div>



<!-- FullCalendar JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    console.log("Calendar JS loaded:", typeof FullCalendar);

    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
        console.error("Calendar element not found!");
        return;
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: "auto",
        contentHeight: "auto",
        expandRows: true,
        events: "/api/events",
        headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay"
        },
        eventDisplay: "block"
    });

    console.log("Rendering calendarâ€¦");
    calendar.render();
});

document.addEventListener("DOMContentLoaded", () => {

    async function loadDailySummary() {
        try {
            const res = await fetch("/daily_summary");
            const data = await res.json();

            const container = document.getElementById("daily-summary");

            if (data.length === 0) {
                container.innerHTML = `
                    <p class="text-success">No components due today ðŸŽ‰</p>
                `;
                return;
            }

            let html = `
                <table class="table table-bordered table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Item</th>
                            <th>Coach</th>
                            <th>Section</th>
                            <th>Component</th>
                            <th>Supplier</th>
                            <th>CTED Due</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(row => {
                html += `
                    <tr>
                        <td>${row.id}</td>
                        <td>${row.item_no || "â€”"}</td>
                        <td>${row.coach_no}</td>
                        <td>${row.section}</td>
                        <td>${row.component}</td>
                        <td>${row.supplier || "â€”"}</td>
                        <td>${row.cted_due}</td>
                        <td>${row.status || "â€”"}</td>
                    </tr>
                `;
            });

            html += "</tbody></table>";

            container.innerHTML = html;

        } catch (err) {
            console.error("Error loading summary:", err);
        }
    }

    loadDailySummary();
});

</script>

{% endblock %}
