{% extends "base.html" %}
{% block content %}

<h3 class="fw-bold mb-3">Audit Logs</h3>

<div class="card shadow-sm mb-4">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>When</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Target</th>
                        <th>Details</th>
                    </tr>
                </thead>

                <tbody>
                    {% for log in logs.items %}
                    <tr>
                        <td>{{ log.timestamp.strftime("%Y-%m-%d %H:%M:%S") }}</td>
                        <td>{{ log.username }}</td>
                        <td>{{ log.action }}</td>
                        <td>{{ log.target }}</td>

                        <td>
                            {% if log.old_value or log.new_value %}
                                <a href="#log-{{ log.id }}" data-bs-toggle="collapse">View changes</a>
                            {% else %}
                                â€”
                            {% endif %}
                        </td>
                    </tr>

                    {% if log.old_value or log.new_value %}
                    <tr id="log-{{ log.id }}" class="collapse">
                        <td colspan="5">
                            <div class="p-3 bg-light border rounded">

                                {% set old = log.old_value_json %}
                                {% set new = log.new_value_json %}

                                <h6 class="fw-bold mb-2">Field Changes</h6>

                                <table class="table table-sm table-bordered">
                                    <thead class="table-secondary">
                                        <tr>
                                            <th>Field</th>
                                            <th>Old Value</th>
                                            <th>New Value</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        {% for field, old_val in old.items() %}
                                            <tr>
                                                <td>{{ field }}</td>
                                                <td class="bg-danger-subtle">{{ old_val }}</td>
                                                <td class="bg-success-subtle">{{ new.get(field) }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<nav>
    <ul class="pagination">
        {% if logs.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('audit_logs', page=logs.prev_num) }}">Previous</a>
        </li>
        {% endif %}

        <li class="page-item active">
            <span class="page-link">Page {{ logs.page }} of {{ logs.pages }}</span>
        </li>

        {% if logs.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('audit_logs', page=logs.next_num) }}">Next</a>
        </li>
        {% endif %}
    </ul>
</nav>

{% endblock %}
