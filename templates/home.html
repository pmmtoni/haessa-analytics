{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <!-- Title + Add Button -->
  <div class="d-flex align-items-center mb-4">
    <h3 class="mb-0 me-auto">Components</h3>
    {% if current_user.role in ["admin", "editor"] %}
      <a href="{{ url_for('add_component') }}" class="btn btn-success">
        ➕ Add Component
      </a>
    {% endif %}
  </div>

  <!-- Search & Status Filter Form -->
  <form method="GET" class="mb-4">
    <div class="row g-3 align-items-end">
      <!-- Search -->
      <div class="col-md-5 col-12">
        <label class="form-label">Search</label>
        <input type="text" name="search" class="form-control"
               placeholder="Component, Coach, Supplier, Item No..."
               value="{{ search }}">
      </div>

      <!-- Status Filter -->
      <div class="col-md-4 col-8">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="" {% if not status_filter %}selected{% endif %}>All Statuses</option>
          {% for status in status_choices %}
            <option value="{{ status }}" {% if status_filter == status %}selected{% endif %}>
              {{ status }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Buttons -->
      <div class="col-md-3 col-4 d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1">Apply Filter</button>
        <a href="{{ url_for('home') }}" class="btn btn-outline-secondary flex-grow-1">Clear</a>
      </div>
    </div>
  </form>

  <!-- Overdue Alert -->
  {% if overdue_count > 0 %}
  <div class="alert alert-danger mb-4">
    <strong>Overdue Components: {{ overdue_count }}</strong>
  </div>
  {% endif %}

  <!-- Components Table -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table id="componentsTable" class="table table-hover table-striped mb-0">
          <thead class="table-dark">
            <tr>
              <th data-sort="id" class="sortable">ID ▲▼</th>
              <th data-sort="item" class="sortable">Item ▲▼</th>
              <th data-sort="coach" class="sortable">Coach ▲▼</th>
              <th data-sort="Coach_Type" class="sortable">Coach_Type ▲▼</th>
              <th data-sort="component" class="sortable">Component ▲▼</th>
              <th data-sort="status" class="sortable">Status ▲▼</th>
              <th style="width: 180px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if components %}
              {% for c in components %}
              <tr class="{% if c.is_overdue %}table-danger{% endif %}">
                <td data-id="{{ c.id }}">{{ c.id }}</td>
                <td data-item="{{ c.Item_no }}">{{ c.Item_no or '—' }}</td>
                <td data-coach="{{ c.Coach_no }}">{{ c.Coach_no or '—' }}</td>
                <td data-Coach_Type="{{ c.Coach_Type }}">{{ c.Coach_Type or '—' }}</td>
                <td data-component="{{ c.Component }}">{{ c.Component or '—' }}</td>
                <td data-status="{{ c.display_status }}">
                  <!-- Color-coded badge -->
                  <span class="badge 
                    {% if c.display_status == 'Delivered' %}bg-success{% elif c.display_status == 'Overdue' %}bg-danger{% elif c.display_status == 'Unknown' %}bg-secondary{% elif c.display_status == 'Being processed' %}bg-info{% elif c.display_status == 'Haessa to order' %}bg-warning{% else %}bg-primary{% endif %}">
                    {{ c.display_status or '—' }}
                  </span>
                  {% if c.missing_fields %}
                    <small class="text-muted d-block mt-1">
                      Missing: {{ c.missing_fields | join(', ') }}
                    </small>
                  {% endif %}
                </td>
                <td>
                  {% if current_user.role == "viewer" %}
                    <span class="text-muted fst-italic">Read-only</span>
                  {% elif current_user.role == "editor" %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_component', id=c.id) }}">Edit</a>
                  {% elif current_user.role == "admin" %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_component', id=c.id) }}">Edit</a>
                    <a class="btn btn-sm btn-outline-danger" href="{{ url_for('delete_component', id=c.id) }}" onclick="return confirm('Delete component?');">Delete</a>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  No components found matching your search or filter.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
  /* Table hover & contrast */
  .table th, .table td {
    color: #212529 !important;
    transition: background-color 0.2s ease;
  }
  .table-hover tbody tr:hover td,
  .table-hover tbody tr:hover th {
    background-color: #f1f3f5 !important;
    color: #212529 !important;
  }
  .table-active td,
  .table-active th {
    background-color: #e9ecef !important;
    color: #212529 !important;
  }
  .table thead th {
    background-color: #e9ecef !important;
    color: #212529 !important;
    font-weight: 600;
  }
  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0,0,0,0.02);
  }

  /* Sortable headers */
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { background: rgba(255,255,255,0.1); }
  .table-dark th { color: white; }
</style>

<!-- Sortable Table JS -->
<script>
document.querySelectorAll("th.sortable").forEach(th => {
  th.addEventListener("click", () => {
    const table = document.getElementById("componentsTable");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const sortKey = th.getAttribute("data-sort");
    const currentDirection = th.getAttribute("data-direction") || "asc";
    const newDirection = currentDirection === "asc" ? "desc" : "asc";
    th.setAttribute("data-direction", newDirection);
    rows.sort((a, b) => {
      const A = a.querySelector(`[data-${sortKey}]`)?.dataset[sortKey]?.toLowerCase() || "";
      const B = b.querySelector(`[data-${sortKey}]`)?.dataset[sortKey]?.toLowerCase() || "";
      if (!isNaN(A) && !isNaN(B)) {
        return newDirection === "asc" ? A - B : B - A;
      }
      return newDirection === "asc" ? A.localeCompare(B) : B.localeCompare(A);
    });
    tbody.innerHTML = "";
    rows.forEach(r => tbody.appendChild(r));
  });
});
</script>

<!-- Highlight search matches -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchTerm = new URLSearchParams(window.location.search).get("search");
  if (!searchTerm) return;
  const regex = new RegExp(`(${searchTerm})`, "gi");
  document.querySelectorAll("td").forEach(td => {
    if (td.textContent.toLowerCase().includes(searchTerm.toLowerCase())) {
      td.innerHTML = td.innerHTML.replace(regex, '<mark class="bg-warning">$1</mark>');
    }
  });
});
</script>
{% endblock %}